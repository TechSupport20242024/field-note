<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>ç¾å ´ãƒãƒ¼ãƒˆ - ITãƒ©ã‚¤ãƒ•ãƒ¯ãƒ¼ã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Hiragino Sans','Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background:#0f172a;color:#e2e8f0;overscroll-behavior:none;-webkit-text-size-adjust:100%}
input,textarea,select,button{font-family:inherit}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
@keyframes popIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield}
input[type=date]{color-scheme:dark}
.mono{font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace}
</style>
</head>
<body>
<div id="root"></div>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script>
'use strict';
const {useState,useEffect,createElement:h,Fragment}=React;

// ============================================================
// SVG ICONS
// ============================================================
const svg=(d,sz=16,ex={})=>h('svg',{xmlns:'http://www.w3.org/2000/svg',width:sz,height:sz,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round',style:{flexShrink:0,...(ex.style||{})},...ex},typeof d==='string'?h('path',{d}):d);
const I={
  Plus:s=>svg(h(Fragment,null,h('line',{x1:12,y1:5,x2:12,y2:19}),h('line',{x1:5,y1:12,x2:19,y2:12})),s),
  ChevronRight:s=>svg('M9 18l6-6-6-6',s),
  Clock:s=>svg(h(Fragment,null,h('circle',{cx:12,cy:12,r:10}),h('polyline',{points:'12 6 12 12 16 14'})),s),
  MapPin:s=>svg(h(Fragment,null,h('path',{d:'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'}),h('circle',{cx:12,cy:10,r:3})),s),
  Wallet:s=>svg(h(Fragment,null,h('path',{d:'M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4'}),h('path',{d:'M4 6v12a2 2 0 0 0 2 2h14v-4'}),h('circle',{cx:18,cy:12,r:1})),s),
  AlertTriangle:s=>svg(h(Fragment,null,h('path',{d:'M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z'}),h('line',{x1:12,y1:9,x2:12,y2:13}),h('line',{x1:12,y1:17,x2:12.01,y2:17})),s),
  CheckCircle:s=>svg(h(Fragment,null,h('path',{d:'M22 11.08V12a10 10 0 1 1-5.93-9.14'}),h('polyline',{points:'22 4 12 14.01 9 11.01'})),s),
  X:s=>svg(h(Fragment,null,h('line',{x1:18,y1:6,x2:6,y2:18}),h('line',{x1:6,y1:6,x2:18,y2:18})),s),
  Send:s=>svg(h(Fragment,null,h('line',{x1:22,y1:2,x2:11,y2:13}),h('polygon',{points:'22 2 15 22 11 13 2 9 22 2'})),s),
  Activity:s=>svg('M22 12h-4l-3 9L9 3l-3 9H2',s),
  FileText:s=>svg(h(Fragment,null,h('path',{d:'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'}),h('polyline',{points:'14 2 14 8 20 8'}),h('line',{x1:16,y1:13,x2:8,y2:13}),h('line',{x1:16,y1:17,x2:8,y2:17})),s),
  Zap:s=>svg('M13 2L3 14h9l-1 8 10-12h-9l1-8',s),
  Target:s=>svg(h(Fragment,null,h('circle',{cx:12,cy:12,r:10}),h('circle',{cx:12,cy:12,r:6}),h('circle',{cx:12,cy:12,r:2})),s),
  Briefcase:s=>svg(h(Fragment,null,h('rect',{x:2,y:7,width:20,height:14,rx:2,ry:2}),h('path',{d:'M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16'})),s),
  Users:s=>svg(h(Fragment,null,h('path',{d:'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'}),h('circle',{cx:9,cy:7,r:4}),h('path',{d:'M23 21v-2a4 4 0 0 0-3-3.87'}),h('path',{d:'M16 3.13a4 4 0 0 1 0 7.75'})),s),
  Route:s=>svg(h(Fragment,null,h('circle',{cx:6,cy:19,r:3}),h('path',{d:'M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15'}),h('circle',{cx:18,cy:5,r:3})),s),
  Info:s=>svg(h(Fragment,null,h('circle',{cx:12,cy:12,r:10}),h('line',{x1:12,y1:16,x2:12,y2:12}),h('line',{x1:12,y1:8,x2:12.01,y2:8})),s),
  CreditCard:s=>svg(h(Fragment,null,h('rect',{x:1,y:4,width:22,height:16,rx:2,ry:2}),h('line',{x1:1,y1:10,x2:23,y2:10})),s),
  RefreshCw:s=>svg(h(Fragment,null,h('polyline',{points:'23 4 23 10 17 10'}),h('polyline',{points:'1 20 1 14 7 14'}),h('path',{d:'M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15'})),s),
  Star:s=>svg('M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z',s),
  Heart:s=>svg('M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z',s),
  Timer:s=>svg(h(Fragment,null,h('circle',{cx:12,cy:13,r:8}),h('path',{d:'M12 9v4l2 2'}),h('path',{d:'M5 3L2 6'}),h('path',{d:'M22 6l-3-3'})),s),
  Settings:s=>svg(h(Fragment,null,h('circle',{cx:12,cy:12,r:3}),h('path',{d:'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z'})),s),
  Award:s=>svg(h(Fragment,null,h('circle',{cx:12,cy:8,r:7}),h('polyline',{points:'8.21 13.89 7 23 12 20 17 23 15.79 13.88'})),s),
  AlertCircle:s=>svg(h(Fragment,null,h('circle',{cx:12,cy:12,r:10}),h('line',{x1:12,y1:8,x2:12,y2:12}),h('line',{x1:12,y1:16,x2:12.01,y2:16})),s),
};

// ============================================================
// â˜… GAS Web App URL â€” ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ã“ã“ã«URLã‚’è²¼ã‚‹ â˜…
// ============================================================
const API_URL = '';

// ============================================================
// CONFIG
// ============================================================
const CFG={rohThreshold:4000,gasCostPerKm:15,platformFeeThreshold:10000,platformFeeFlat:2500,platformFeeRate:.2,annualTarget:2840000,avgSpeedKmH:30};
const CHANNELS=['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ çµŒç”±','ç›´æ¥ï¼ˆLINEãƒ»ç´¹ä»‹ãƒ»æ—¢å­˜ï¼‰'];
const CUSTOMER_TYPES=['ä¸€èˆ¬','æœˆé¡ã‚µãƒãƒ¼ãƒˆä¼šå“¡'];

// ============================================================
// DATA DEFINITIONS
// ============================================================
const BURDEN_LEVELS=[
  {id:1,emoji:'ğŸ’ª',label:'æ¥½å‹',color:'#10b981',bg:'rgba(16,185,129,0.12)',border:'rgba(16,185,129,0.3)',weight:1.2,desc:'ä½™è£•ã‚ã‚Š'},
  {id:2,emoji:'ğŸ˜Š',label:'å¿«é©',color:'#3b82f6',bg:'rgba(59,130,246,0.12)',border:'rgba(59,130,246,0.3)',weight:1.1,desc:'ã„ã„æ„Ÿã˜'},
  {id:3,emoji:'ğŸ˜',label:'ãµã¤ã†',color:'#94a3b8',bg:'rgba(148,163,184,0.12)',border:'rgba(148,163,184,0.3)',weight:1.0,desc:'ã„ã¤ã‚‚é€šã‚Š'},
  {id:4,emoji:'ğŸ˜®â€ğŸ’¨',label:'ç–²ã‚ŒãŸ',color:'#f59e0b',bg:'rgba(245,158,11,0.12)',border:'rgba(245,158,11,0.3)',weight:.8,desc:'ã‘ã£ã“ã†å¤§å¤‰'},
  {id:5,emoji:'ğŸ˜«',label:'æ¶ˆè€—',color:'#ef4444',bg:'rgba(239,68,68,0.12)',border:'rgba(239,68,68,0.3)',weight:.6,desc:'äºŒåº¦ã¨ã‚„ã‚ŠãŸããªã„'},
];
const SATISFACTION_LEVELS=[
  {id:1,emoji:'ğŸ˜„',label:'å¤§æº€è¶³',color:'#10b981',bg:'rgba(16,185,129,0.12)',border:'rgba(16,185,129,0.3)'},
  {id:2,emoji:'ğŸ™‚',label:'æº€è¶³',color:'#3b82f6',bg:'rgba(59,130,246,0.12)',border:'rgba(59,130,246,0.3)'},
  {id:3,emoji:'ğŸ˜',label:'ãµã¤ã†',color:'#94a3b8',bg:'rgba(148,163,184,0.12)',border:'rgba(148,163,184,0.3)'},
  {id:4,emoji:'ğŸ˜•',label:'å¾®å¦™',color:'#f59e0b',bg:'rgba(245,158,11,0.12)',border:'rgba(245,158,11,0.3)'},
];
const PAYMENT_STATUS=[
  {id:'cash',emoji:'ğŸ’°',label:'ç¾é‡‘',color:'#10b981'},
  {id:'digital',emoji:'ğŸ“±',label:'é›»å­æ±ºæ¸ˆ',color:'#3b82f6'},
  {id:'credit',emoji:'ğŸ’³',label:'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ',color:'#8b5cf6'},
  {id:'invoice',emoji:'ğŸ“„',label:'è«‹æ±‚æ›¸',color:'#f59e0b'},
  {id:'pending',emoji:'â³',label:'æœªå›å',color:'#ef4444'},
];
const REPEAT_POTENTIAL=[
  {id:'high',emoji:'ğŸ”¥',label:'é«˜ã„',desc:'æ¬¡ã®ä¾é ¼ã‚ã‚Š',color:'#10b981'},
  {id:'medium',emoji:'ğŸ”„',label:'ã‚ã‚Š',desc:'ã¾ãŸé ¼ã¿ãã†',color:'#3b82f6'},
  {id:'unknown',emoji:'â“',label:'ä¸æ˜',desc:'ã‚ã‹ã‚‰ãªã„',color:'#94a3b8'},
  {id:'low',emoji:'â–',label:'ãªã—',desc:'å˜ç™ºã§çµ‚äº†',color:'#64748b'},
];
const MONTHLY_PITCH=[
  {id:'joined',emoji:'ğŸ‰',label:'åŠ å…¥ã—ãŸ',color:'#10b981',bg:'rgba(16,185,129,0.12)',border:'rgba(16,185,129,0.3)'},
  {id:'pitched',emoji:'ğŸ“¢',label:'æ¡ˆå†…ã—ãŸ',color:'#3b82f6',bg:'rgba(59,130,246,0.12)',border:'rgba(59,130,246,0.3)'},
  {id:'not_pitched',emoji:'â–',label:'æ¡ˆå†…ãªã—',color:'#64748b',bg:'rgba(100,116,139,0.12)',border:'rgba(100,116,139,0.3)'},
];
const JOIN_PROBABILITY=[
  {id:100,emoji:'ğŸ¯',label:'100%',color:'#10b981'},
  {id:80,emoji:'ğŸ”¥',label:'80%',color:'#22d3ee'},
  {id:60,emoji:'ğŸ‘',label:'60%',color:'#3b82f6'},
  {id:40,emoji:'ğŸ¤”',label:'40%',color:'#f59e0b'},
  {id:20,emoji:'ğŸ˜…',label:'20%',color:'#f97316'},
  {id:0,emoji:'âŒ',label:'0%',color:'#ef4444'},
];
const CATEGORIES={
  'ãƒ‘ã‚½ã‚³ãƒ³ã‚µãƒãƒ¼ãƒˆ':{'åˆæœŸè¨­å®šãƒ»è²·æ›¿':['æ–°å“PCè¨­å®š','ä¸­å¤PCè¨­å®š','ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ','ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š'],'ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œ':['èµ·å‹•ä¸å¯','å‹•ä½œé…å»¶','ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ•ãƒªãƒ¼ã‚º','ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¸å…·åˆ'],'æ“ä½œèª¬æ˜':['åŸºæœ¬æ“ä½œ','Officeç³»','ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†']},
  'ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ':{'åˆæœŸè¨­å®šãƒ»æ©Ÿç¨®å¤‰æ›´':['iPhoneè¨­å®š','Androidè¨­å®š','ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ','ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†'],'æ“ä½œèª¬æ˜':['LINE','é›»è©±ãƒ»å†™çœŸ','ã‚¢ãƒ—ãƒªç®¡ç†'],'ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œ':['é€šä¿¡ãƒˆãƒ©ãƒ–ãƒ«','è©æ¬ºãƒ»è¿·æƒ‘åºƒå‘Šå¯¾å¿œ']},
  'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯':{'Wi-Fiæ”¹å–„':['é€Ÿåº¦æ”¹å–„','ãƒ«ãƒ¼ã‚¿ãƒ¼è¨­ç½®ãƒ»äº¤æ›','ä¸­ç¶™æ©Ÿãƒ»ãƒ¡ãƒƒã‚·ãƒ¥å°å…¥','Wi-Fiè¨­å®šå¤‰æ›´'],'ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œ':['æ¥ç¶šä¸å¯','ç‰¹å®šæ©Ÿå™¨ã ã‘ç¹‹ãŒã‚‰ãªã„','é€Ÿåº¦ä½ä¸‹','ãƒ«ãƒ¼ã‚¿ãƒ¼å†èµ·å‹•ã§å¾©æ—§ã—ãªã„']},
  'ITç›¸è«‡ãƒ»é¡§å•':{'åˆ¤æ–­ä»£è¡Œ':['è³¼å…¥ç›¸è«‡','å¥‘ç´„ãƒã‚§ãƒƒã‚¯','ã‚»ã‚«ãƒ³ãƒ‰ã‚ªãƒ”ãƒ‹ã‚ªãƒ³'],'ä¼´èµ°æ”¯æ´':['æœˆé¡ã‚µãƒãƒ¼ãƒˆ','å®šæœŸè¨ªå•']},
  'äº‹æ¥­è€…å‘ã‘DX':{'æ¥­å‹™åŠ¹ç‡åŒ–':['ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚·ãƒ¼ãƒˆæ§‹ç¯‰','ãƒ„ãƒ¼ãƒ«å°å…¥','è‡ªå‹•åŒ–'],'å¤–éƒ¨ITé¡§å•':['ç¾çŠ¶åˆ†æ','DXææ¡ˆ','ä¼´èµ°å‹æ”¯æ´']},
};

// ============================================================
// CALC
// ============================================================
function calcGasCost(rtKm){return Math.round(rtKm*CFG.gasCostPerKm)}
function calcPlatformFee(ch,rev){if(ch!==CHANNELS[0])return 0;return rev<=CFG.platformFeeThreshold?CFG.platformFeeFlat:Math.round(rev*CFG.platformFeeRate)}
function calcGrossProfit(rev,mat,pf,gas){return rev-mat-pf-gas}
function calcROH(profit,wh,th){return(wh+th)>0?Math.round(profit/(wh+th)):0}
function calcMinPrice(ch,totalH,mat,gas){const b=CFG.rohThreshold*totalH+mat+gas;if(ch!==CHANNELS[0])return Math.ceil(b);if(b+CFG.platformFeeFlat<=CFG.platformFeeThreshold)return Math.ceil(b+CFG.platformFeeFlat);return Math.ceil(b/(1-CFG.platformFeeRate))}
function calcFeltROH(roh,bid){const b=BURDEN_LEVELS.find(l=>l.id===bid);return b?Math.round(roh*b.weight):roh}
function estimateTravelHours(owKm){if(!owKm||owKm<=0)return 0;const rt=owKm*2,drH=rt/CFG.avgSpeedKmH,ovH=10/60;return Math.round((drH+ovH)*4)/4}
function fmt(n){return'\u00a5'+n.toLocaleString()}

// ============================================================
// API
// ============================================================
async function apiGet(action,params={}){if(!API_URL)return null;const u=new URL(API_URL);u.searchParams.set('action',action);Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));const r=await fetch(u);return r.json()}
async function apiPost(action,data){if(!API_URL)return null;const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action,data})});return r.json()}

// ============================================================
// API STATUS BANNER
// ============================================================
function ApiBanner(){
  if(API_URL)return null;
  return h('div',{style:{margin:'8px 16px',padding:'12px 16px',borderRadius:12,background:'rgba(245,158,11,0.1)',border:'1px solid rgba(245,158,11,0.25)',display:'flex',alignItems:'flex-start',gap:10}},
    h('span',{style:{color:'#f59e0b',flexShrink:0,marginTop:2}},I.AlertCircle(16)),
    h('div',null,
      h('div',{style:{fontSize:12,fontWeight:600,color:'#f59e0b'}},'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰'),
      h('div',{style:{fontSize:11,color:'#94a3b8',marginTop:2,lineHeight:1.5}},'GASæœªæ¥ç¶šã§ã™ã€‚index.html ã® API_URL ã«GASãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã™ã‚‹ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚')
    )
  );
}

// ============================================================
// Sticky ROH Header
// ============================================================
function StickyROHBar({roh,isActive,grossProfit,gasCost,pfFee,minPrice,revenue,totalHours,workHours,travelHours,burdenId}){
  const gap=revenue-minPrice;
  const feltROH=burdenId?calcFeltROH(roh,burdenId):null;
  let accent='#475569',IconFn=null;
  if(isActive){
    if(roh>=CFG.rohThreshold){accent='#10b981';IconFn=()=>I.CheckCircle(20)}
    else if(roh>=CFG.rohThreshold*.75){accent='#f59e0b';IconFn=()=>I.AlertTriangle(20)}
    else{accent='#ef4444';IconFn=()=>I.AlertTriangle(20)}
  }
  return h('div',{style:{position:'sticky',top:0,zIndex:40,background:'rgba(15,23,42,0.97)',backdropFilter:'blur(16px)',borderBottom:'1px solid '+accent+'33'}},
    h('div',{style:{padding:'10px 16px',display:'flex',alignItems:'center',justifyContent:'space-between'}},
      h('div',{style:{display:'flex',alignItems:'center',gap:12}},
        IconFn?h('span',{style:{color:accent}},IconFn()):h('div',{style:{width:20,height:20,borderRadius:'50%',border:'2px solid #475569'}}),
        h('div',null,h('div',{style:{fontSize:10,color:'#64748b',lineHeight:1,marginBottom:2}},'ROH'),h('div',{className:'mono',style:{fontSize:24,fontWeight:700,lineHeight:1,color:isActive?accent:'#475569'}},isActive?fmt(roh):'---'))
      ),
      isActive&&h('div',{style:{display:'flex',alignItems:'center',gap:12}},
        h('div',{style:{textAlign:'right'}},h('div',{style:{fontSize:10,color:'#64748b',lineHeight:1,marginBottom:2}},'ç²—åˆ©'),h('div',{className:'mono',style:{fontSize:15,fontWeight:700,color:'#fff',lineHeight:1}},fmt(grossProfit))),
        h('div',{style:{textAlign:'right',minWidth:56}},h('div',{style:{fontSize:10,color:'#64748b',lineHeight:1,marginBottom:2}},gap>=0?'ä½™è£•':'ä¸è¶³'),h('div',{className:'mono',style:{fontSize:15,fontWeight:700,lineHeight:1,color:gap>=0?'#10b981':'#ef4444'}},(gap>=0?'+':'')+fmt(gap)))
      )
    ),
    isActive&&h('div',{style:{padding:'0 16px 8px',display:'flex',alignItems:'center',gap:12,flexWrap:'wrap'}},
      h('span',{style:{fontSize:11,color:'#60a5fa',fontWeight:600,display:'flex',alignItems:'center',gap:4}},I.Timer(11),' è¨ˆ'+totalHours+'h',h('span',{style:{color:'#475569',fontWeight:400}},' ('+workHours+'hä½œæ¥­+'+travelHours+'hç§»å‹•)')),
      gasCost>0&&h('span',{style:{fontSize:11,color:'#64748b'}},'â›½'+fmt(gasCost)),
      pfFee>0&&h('span',{style:{fontSize:11,color:'#64748b'}},'PF'+fmt(pfFee)),
      minPrice>0&&h('span',{style:{fontSize:11,color:'#64748b',display:'flex',alignItems:'center',gap:2}},I.Target(10),'æœ€ä½'+fmt(minPrice))
    ),
    isActive&&feltROH!==null&&feltROH!==roh&&h('div',{style:{padding:'0 16px 8px'}},
      h('div',{style:{display:'flex',alignItems:'center',gap:8,padding:'6px 12px',borderRadius:12,background:feltROH>=CFG.rohThreshold?'rgba(16,185,129,0.08)':'rgba(239,68,68,0.08)'}},
        h('span',{style:{color:feltROH>=CFG.rohThreshold?'#10b981':'#ef4444'}},I.Heart(12)),
        h('span',{style:{fontSize:11,color:'#94a3b8'}},'ä½“æ„ŸROH ',h('strong',{className:'mono',style:{color:feltROH>=CFG.rohThreshold?'#10b981':'#ef4444'}},fmt(feltROH)),h('span',{style:{color:'#475569',marginLeft:4}},'ï¼ˆè² è·è£œæ­£å¾Œï¼‰'))
      )
    ),
    isActive&&roh>0&&roh<CFG.rohThreshold&&minPrice>0&&h('div',{style:{padding:'0 16px 8px'}},
      h('div',{style:{display:'flex',alignItems:'center',gap:8,padding:'8px 12px',borderRadius:12,background:'rgba(239,68,68,0.1)'}},
        h('span',{style:{color:'#fbbf24',flexShrink:0}},I.Zap(14)),
        h('span',{style:{fontSize:12,color:'#cbd5e1'}},h('strong',{style:{color:'#fbbf24'}},fmt(minPrice)),' ä»¥ä¸Šãªã‚‰ROH \u00a54,000ç¢ºä¿')
      )
    )
  );
}

// ============================================================
// SHARED COMPONENTS
// ============================================================
function EmojiSelector({items,value,onChange,columns}){
  const cols=columns||items.length;
  return h('div',{style:{display:'grid',gridTemplateColumns:'repeat('+cols+',1fr)',gap:8}},
    items.map(item=>{
      const sel=value===item.id;
      return h('button',{key:item.id,onClick:()=>onChange(sel?null:item.id),
        style:{display:'flex',flexDirection:'column',alignItems:'center',padding:'12px 4px',borderRadius:16,border:'2px solid '+(sel?(item.border||item.color+'55'):'transparent'),background:sel?(item.bg||item.color+'18'):'#1e293b',transition:'all .15s',cursor:'pointer',boxShadow:sel?'0 0 16px '+(item.bg||item.color+'18'):'none'}},
        h('span',{style:{fontSize:24,lineHeight:1,marginBottom:4}},item.emoji),
        h('span',{style:{fontSize:11,fontWeight:600,lineHeight:1.2,color:sel?item.color:'#64748b'}},item.label),
        item.desc&&h('span',{style:{fontSize:9,marginTop:2,lineHeight:1.2,color:sel?(item.color+'99'):'#475569'}},item.desc)
      );
    })
  );
}

function GridSelector({items,value,onChange,columns}){
  const cols=columns||items.length;
  return h('div',{style:{display:'grid',gridTemplateColumns:'repeat('+cols+',1fr)',gap:8}},
    items.map(item=>{
      const sel=value===item.id;
      return h('button',{key:item.id,onClick:()=>onChange(sel?null:item.id),
        style:{display:'flex',flexDirection:'column',alignItems:'center',padding:'12px 4px',borderRadius:16,border:'2px solid '+(sel?item.color+'55':'transparent'),background:sel?item.color+'18':'#1e293b',cursor:'pointer',transition:'all .15s'}},
        h('span',{style:{fontSize:20,marginBottom:4}},item.emoji),
        h('span',{style:{fontSize:10,fontWeight:600,color:sel?item.color:'#64748b'}},item.label),
        item.desc&&h('span',{style:{fontSize:8,marginTop:2,color:sel?item.color+'99':'#475569'}},item.desc)
      );
    })
  );
}

function CustomerPicker({value,onChange,customers,onCustomerSelect}){
  const[isOpen,setIsOpen]=useState(false);
  const[search,setSearch]=useState('');
  const filtered=customers.filter(c=>c.name.includes(search)||c.name.toLowerCase().includes(search.toLowerCase()));
  return h('div',{style:{position:'relative'}},
    h('div',{style:{position:'relative'}},
      h('input',{type:'text',value,onChange:e=>{onChange(e.target.value);setSearch(e.target.value);setIsOpen(true)},onFocus:()=>{if(customers.length>0)setIsOpen(true)},placeholder:'é¡§å®¢åã‚’å…¥åŠ›...',style:{width:'100%',padding:'14px 16px',borderRadius:16,fontSize:16,color:'#fff',background:'#1e293b',border:'none',outline:'none'}}),
      value&&h('button',{onClick:()=>{onChange('');setSearch('')},style:{position:'absolute',right:8,top:'50%',transform:'translateY(-50%)',width:36,height:36,display:'flex',alignItems:'center',justifyContent:'center',borderRadius:'50%',background:'#334155',border:'none',cursor:'pointer',color:'#cbd5e1'}},I.X(16))
    ),
    isOpen&&customers.length>0&&h(Fragment,null,
      h('div',{onClick:()=>setIsOpen(false),style:{position:'fixed',inset:0,zIndex:20}}),
      h('div',{style:{position:'absolute',zIndex:30,width:'100%',marginTop:8,borderRadius:16,overflow:'hidden',boxShadow:'0 25px 50px rgba(0,0,0,.5)',border:'1px solid rgba(51,65,85,.5)',maxHeight:320,overflowY:'auto',background:'#1e293b'}},
        filtered.length>0?filtered.map((c,i)=>{
          const bi=BURDEN_LEVELS.find(b=>b.id===Math.round(c.avgBurden));
          return h('button',{key:i,onClick:()=>{onCustomerSelect(c);setIsOpen(false);setSearch('')},style:{width:'100%',padding:'16px',display:'flex',alignItems:'center',justifyContent:'space-between',border:'none',borderBottom:'1px solid rgba(51,65,85,.3)',background:'transparent',cursor:'pointer',minHeight:56,color:'#fff',textAlign:'left'}},
            h('div',{style:{display:'flex',alignItems:'center',gap:12}},
              h('div',{style:{width:12,height:12,borderRadius:'50%',flexShrink:0,background:c.type==='æœˆé¡ã‚µãƒãƒ¼ãƒˆä¼šå“¡'?'#34d399':'#64748b'}}),
              h('div',null,h('div',{style:{fontSize:15,color:'#fff'}},c.name),h('div',{style:{fontSize:12,color:'#64748b',marginTop:2}},c.caseCount+'ä»¶'+(c.lastKm?' ãƒ» ç‰‡é“'+c.lastKm+'km':'')))
            ),
            h('div',{style:{textAlign:'right',flexShrink:0,marginLeft:12}},
              c.avgROH>0&&h('div',{className:'mono',style:{fontSize:12,fontWeight:600,color:c.avgROH>=CFG.rohThreshold?'#10b981':'#f59e0b'}},fmt(c.avgROH)),
              bi&&h('div',{style:{fontSize:11,marginTop:2}},bi.emoji)
            )
          );
        }):h('div',{style:{padding:'24px 16px',textAlign:'center',fontSize:13,color:'#94a3b8'}},'è©²å½“ãªã—ï¼ˆæ–°è¦é¡§å®¢ã¨ã—ã¦è¨˜éŒ²ï¼‰')
      )
    )
  );
}

function CategoryCascade({catLarge,catMedium,catSmall,onChange}){
  const lKeys=Object.keys(CATEGORIES),mKeys=catLarge?Object.keys(CATEGORIES[catLarge]||{}):[],sKeys=catLarge&&catMedium?(CATEGORIES[catLarge]?.[catMedium]||[]):[];
  const chip=(sel,color)=>({padding:'10px 16px',borderRadius:12,fontSize:13,fontWeight:600,border:'none',cursor:'pointer',whiteSpace:'nowrap',background:sel?color:'#1e293b',color:sel?'#fff':'#cbd5e1',boxShadow:sel?'0 4px 12px '+color+'40':'none',transition:'all .15s'});
  return h('div',{style:{display:'flex',flexDirection:'column',gap:12}},
    h('div',null,h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.Briefcase(12),' ã‚¸ãƒ£ãƒ³ãƒ«'),h('div',{style:{display:'flex',flexWrap:'wrap',gap:8}},lKeys.map(k=>h('button',{key:k,onClick:()=>onChange({catLarge:k,catMedium:'',catSmall:''}),style:chip(catLarge===k,'#2563eb')},k)))),
    catLarge&&mKeys.length>0&&h('div',{style:{animation:'slideDown .25s ease-out'}},h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,marginLeft:12,display:'flex',alignItems:'center',gap:4}},I.ChevronRight(11),' ç¨®åˆ¥'),h('div',{style:{display:'flex',flexWrap:'wrap',gap:8,marginLeft:12}},mKeys.map(k=>h('button',{key:k,onClick:()=>onChange({catLarge,catMedium:k,catSmall:''}),style:chip(catMedium===k,'#4f46e5')},k)))),
    catMedium&&sKeys.length>0&&h('div',{style:{animation:'slideDown .25s ease-out'}},h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,marginLeft:24,display:'flex',alignItems:'center',gap:4}},I.ChevronRight(11),' è©³ç´°'),h('div',{style:{display:'flex',flexWrap:'wrap',gap:8,marginLeft:24}},sKeys.map(k=>h('button',{key:k,onClick:()=>onChange({catLarge,catMedium,catSmall:k}),style:chip(catSmall===k,'#7c3aed')},k))))
  );
}

function NumInput({label,iconFn,value,onChange,unit,step=1,sublabel}){
  return h('div',null,
    h('label',{style:{fontSize:12,color:'#64748b',marginBottom:6,display:'flex',alignItems:'center',gap:6}},iconFn&&iconFn(12),' ',label,sublabel&&h('span',{style:{color:'#475569',marginLeft:4}},'('+sublabel+')')),
    h('div',{style:{position:'relative'}},
      h('input',{type:'number',inputMode:'decimal',value,onChange:e=>onChange(e.target.value),placeholder:'0',step,min:0,style:{width:'100%',padding:'14px 16px',borderRadius:16,fontSize:16,color:'#fff',background:'#1e293b',border:'none',outline:'none'}}),
      unit&&h('span',{style:{position:'absolute',right:16,top:'50%',transform:'translateY(-50%)',fontSize:12,color:'#64748b'}},unit)
    )
  );
}

function TravelSection({oneWayKm,onChangeKm,estimatedTravelH}){
  const rt=oneWayKm?Number(oneWayKm)*2:0,gas=calcGasCost(rt);
  return h('div',{style:{borderRadius:16,padding:16,display:'flex',flexDirection:'column',gap:12,background:'rgba(15,23,42,0.6)'}},
    h('div',{style:{fontSize:12,fontWeight:600,color:'#94a3b8',display:'flex',alignItems:'center',gap:6}},I.Route(13),' ç§»å‹•'),
    NumInput({label:'ç‰‡é“è·é›¢',iconFn:s=>I.MapPin(s),value:oneWayKm,onChange:onChangeKm,unit:'km',sublabel:'è‡ªå®…â†’è¨ªå•å…ˆ'}),
    rt>0&&h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,animation:'slideDown .2s ease-out'}},
      [{l:'å¾€å¾©',v:rt+'km'},{l:'æ¨å®šæ™‚é–“',v:estimatedTravelH+'h'},{l:'ã‚¬ã‚½ãƒªãƒ³',v:fmt(gas)}].map((d,i)=>h('div',{key:i,style:{borderRadius:12,padding:12,textAlign:'center',background:'#0f172a'}},h('div',{style:{fontSize:10,color:'#64748b',marginBottom:2}},d.l),h('div',{className:'mono',style:{fontSize:15,fontWeight:700,color:'#e2e8f0'}},d.v)))
    ),
    h('div',{style:{display:'flex',alignItems:'flex-start',gap:8,padding:'10px 12px',borderRadius:12,background:'rgba(59,130,246,0.07)'}},h('span',{style:{color:'#60a5fa',flexShrink:0,marginTop:2}},I.Info(13)),h('span',{style:{fontSize:11,color:'#94a3b8',lineHeight:1.6}},'ä¸€èˆ¬é“ å¹³å‡'+CFG.avgSpeedKmH+'km/hã§æ¨å®šï¼ˆä¹—é™10åˆ†è¾¼ã¿ï¼‰'))
  );
}

function HistoryCard({c}){
  const isOK=c.rohStatus&&c.rohStatus.includes('OK');
  const bi=BURDEN_LEVELS.find(b=>b.id===c.burden);
  return h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'16px 0',borderBottom:'1px solid rgba(30,41,59,.5)'}},
    h('div',{style:{display:'flex',alignItems:'center',gap:12}},
      h('div',{style:{width:6,height:48,borderRadius:3,flexShrink:0,background:isOK?'#10b981':'#ef4444'}}),
      h('div',null,h('div',{style:{fontSize:15,color:'#fff',display:'flex',alignItems:'center',gap:6}},c.customerName,bi&&h('span',{style:{fontSize:13}},bi.emoji)),h('div',{style:{fontSize:12,color:'#64748b',marginTop:2}},c.date+(c.catLarge?' ãƒ» '+c.catLarge:'')))
    ),
    h('div',{style:{textAlign:'right',flexShrink:0,marginLeft:12}},
      h('div',{className:'mono',style:{fontSize:15,fontWeight:700,color:'#fff'}},fmt(c.revenue)),
      h('div',{className:'mono',style:{fontSize:12,fontWeight:600,marginTop:2,color:isOK?'#10b981':'#ef4444'}},'ROH '+fmt(c.roh))
    )
  );
}

function MonthPulse({summary,goal}){
  const tp=goal.targetProfit||0;
  const progress=tp>0?Math.min(summary.profit/tp,1):0;
  const pct=Math.round(progress*100);
  const remaining=Math.max(0,tp-summary.profit);
  const barColor=pct>=100?'#10b981':pct>=60?'#3b82f6':pct>=30?'#f59e0b':'#ef4444';
  return h('div',{style:{borderRadius:16,padding:16,background:'linear-gradient(135deg,#0f172a 0%,#1e293b 100%)'}},
    h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}},
      h('div',{style:{display:'flex',alignItems:'center',gap:8}},I.Target(15,{style:{color:'#94a3b8'}}),h('span',{style:{fontSize:13,fontWeight:500,color:'#94a3b8'}},'ä»Šæœˆã®é€²æ—')),
      h('span',{style:{fontSize:12,color:'#64748b'}},summary.cases+'ä»¶'+(goal.requiredCases?' / ç›®æ¨™'+goal.requiredCases+'ä»¶':''))
    ),
    tp>0?h(Fragment,null,
      h('div',{style:{position:'relative',height:36,borderRadius:12,overflow:'hidden',background:'#0f172a'}},
        h('div',{style:{position:'absolute',inset:2,borderRadius:10,overflow:'hidden',background:'#1a2332'}},
          h('div',{style:{height:'100%',borderRadius:10,width:Math.max(pct,5)+'%',background:'linear-gradient(90deg,'+barColor+'88,'+barColor+')',transition:'width 1s ease-out',display:'flex',alignItems:'center',justifyContent:'flex-end',paddingRight:12}},pct>=15&&h('span',{style:{fontSize:13,fontWeight:700,color:'#fff',textShadow:'0 1px 3px rgba(0,0,0,.5)'}},pct+'%'))
        ),
        pct<15&&h('span',{style:{position:'absolute',right:12,top:'50%',transform:'translateY(-50%)',fontSize:13,fontWeight:700,color:'#94a3b8'}},pct+'%')
      ),
      h('div',{style:{display:'flex',justifyContent:'space-between',marginTop:12}},h('span',{style:{fontSize:12,color:'#64748b'}},'ç²—åˆ© '+fmt(summary.profit)),h('span',{style:{fontSize:12,fontWeight:600,color:barColor}},'ã‚ã¨ '+fmt(remaining)))
    ):h('div',{style:{padding:'16px 0',textAlign:'center'}},h('div',{style:{fontSize:13,color:'#64748b',marginBottom:8}},'æœˆæ¬¡ç›®æ¨™ãŒæœªè¨­å®šã§ã™'),h('div',{style:{fontSize:11,color:'#475569'}},'ã€Œè¨­å®šã€ã‚¿ãƒ–ã‹ã‚‰ç›®æ¨™ã‚’è¨­å®šã—ã¦ãã ã•ã„'))
  );
}

// ============================================================
// CASE ENTRY
// ============================================================
function CaseEntry({onSave,customers}){
  const init=()=>({date:new Date().toISOString().split('T')[0],customerName:'',customerType:'ä¸€èˆ¬',channel:CHANNELS[1],catLarge:'',catMedium:'',catSmall:'',revenue:'',materialCost:'',workHours:'',oneWayKm:'',memo:'',burden:null,satisfaction:null,paymentStatus:null,repeatPotential:null,monthlyPitch:null,joinProbability:null});
  const[form,setForm]=useState(init());
  const[isSaving,setIsSaving]=useState(false);
  const[saved,setSaved]=useState(false);
  const u=(k,v)=>setForm(f=>({...f,[k]:v}));
  const rev=Number(form.revenue)||0,mat=Number(form.materialCost)||0,wh=Number(form.workHours)||0,owKm=Number(form.oneWayKm)||0;
  const rtKm=owKm*2,travelH=estimateTravelHours(owKm),totalH=wh+travelH;
  const gas=calcGasCost(rtKm),pf=calcPlatformFee(form.channel,rev);
  const profit=calcGrossProfit(rev,mat,pf,gas),roh=calcROH(profit,wh,travelH);
  const minPrice=totalH>0?calcMinPrice(form.channel,totalH,mat,gas):0;
  const isActive=rev>0&&totalH>0;
  function handleCustomerSelect(c){setForm(f=>({...f,customerName:c.name,customerType:c.type,oneWayKm:c.lastKm?String(c.lastKm):''}))}
  function handleSave(){
    if(!form.customerName||rev<=0)return;
    setIsSaving(true);
    const saveData={...form,roh,grossProfit:profit,minPrice,totalHours:totalH,travelHours:travelH,gasCost:gas,platformFee:pf,travelKm:rtKm};
    const done=()=>{setIsSaving(false);setSaved(true);setTimeout(()=>{setSaved(false);setForm(init());window.scrollTo({top:0,behavior:'smooth'})},2000)};
    if(API_URL){apiPost('addCase',saveData).then(r=>{onSave(saveData,r);done()}).catch(()=>{onSave(saveData,null);done()})}
    else{setTimeout(()=>{onSave(saveData,null);done()},400)}
  }
  const canSave=form.customerName&&rev>0;
  if(saved){
    const feltROH=form.burden?calcFeltROH(roh,form.burden):roh;
    return h('div',{style:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:'96px 16px'}},
      h('div',{style:{width:80,height:80,borderRadius:'50%',background:'rgba(16,185,129,.2)',display:'flex',alignItems:'center',justifyContent:'center',marginBottom:20,animation:'popIn .3s ease-out',color:'#34d399'}},I.CheckCircle(40)),
      h('div',{style:{fontSize:20,fontWeight:700,color:'#fff',marginBottom:8}},'è¨˜éŒ²å®Œäº†'),
      h('div',{className:'mono',style:{fontSize:16,color:'#94a3b8',marginBottom:4}},'ROH '+fmt(roh)),
      form.burden&&feltROH!==roh?h('div',{style:{fontSize:13,color:'#64748b'}},'ä½“æ„ŸROH '+fmt(feltROH)):null,
      !API_URL&&h('div',{style:{marginTop:12,fontSize:11,color:'#f59e0b'}},'â€» GASæœªæ¥ç¶šã®ãŸã‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã¯æœªä¿å­˜')
    );
  }
  const sec=(label,iconFn,children)=>h('div',{style:{borderRadius:16,padding:16,display:'flex',flexDirection:'column',gap:12,background:'rgba(15,23,42,0.6)'}},h('div',{style:{fontSize:12,fontWeight:600,color:'#94a3b8',display:'flex',alignItems:'center',gap:6}},iconFn(13),' ',label),...children);
  const toggle=(items,val,setter,short)=>h('div',{style:{display:'flex',borderRadius:16,overflow:'hidden',background:'#1e293b'}},items.map((t,i)=>h('button',{key:t,onClick:()=>setter(t),style:{flex:1,padding:'14px 0',fontSize:13,fontWeight:600,border:'none',cursor:'pointer',color:val===t?'#fff':'#94a3b8',background:val===t?'#2563eb':'transparent',transition:'all .15s'}},short?short[i]:t)));
  const showJoinProb=form.monthlyPitch==='pitched';

  return h(Fragment,null,
    StickyROHBar({roh,isActive,grossProfit:profit,gasCost:gas,pfFee:pf,minPrice,revenue:rev,totalHours:totalH,workHours:wh,travelHours:travelH,burdenId:form.burden}),
    h('div',{style:{padding:'16px',display:'flex',flexDirection:'column',gap:20,paddingBottom:32}},
      h('div',null,h('label',{style:{fontSize:12,color:'#64748b',marginBottom:6,display:'block'}},'å¯¾å¿œæ—¥'),h('input',{type:'date',value:form.date,onChange:e=>u('date',e.target.value),style:{width:'100%',padding:'14px 16px',borderRadius:16,fontSize:16,color:'#fff',background:'#1e293b',border:'none',outline:'none'}})),
      h('div',null,h('label',{style:{fontSize:12,color:'#64748b',marginBottom:6,display:'flex',alignItems:'center',gap:6}},I.Users(12),' é¡§å®¢'),CustomerPicker({value:form.customerName,onChange:v=>u('customerName',v),customers,onCustomerSelect:handleCustomerSelect})),
      h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}},
        h('div',null,h('label',{style:{fontSize:12,color:'#64748b',marginBottom:6,display:'block'}},'åŒºåˆ†'),toggle(CUSTOMER_TYPES,form.customerType,v=>u('customerType',v),['ä¸€èˆ¬','ä¼šå“¡'])),
        h('div',null,h('label',{style:{fontSize:12,color:'#64748b',marginBottom:6,display:'block'}},'ãƒãƒ£ãƒãƒ«'),toggle(CHANNELS,form.channel,v=>u('channel',v),['PFçµŒç”±','ç›´æ¥']))
      ),
      CategoryCascade({catLarge:form.catLarge,catMedium:form.catMedium,catSmall:form.catSmall,onChange:cats=>setForm(f=>({...f,...cats}))}),
      sec('é‡‘é¡',s=>I.Wallet(s),[NumInput({label:'å£²ä¸Š',value:form.revenue,onChange:v=>u('revenue',v),unit:'å††'}),NumInput({label:'ææ–™è²»',value:form.materialCost,onChange:v=>u('materialCost',v),unit:'å††'})]),
      sec('ç¨¼åƒæ™‚é–“',s=>I.Clock(s),[NumInput({label:'ç¾å ´ã§ã®ä½œæ¥­æ™‚é–“',value:form.workHours,onChange:v=>u('workHours',v),unit:'æ™‚é–“',step:.25,sublabel:'ç§»å‹•ã¯è·é›¢ã‹ã‚‰è‡ªå‹•ç®—å‡º'})]),
      TravelSection({oneWayKm:form.oneWayKm,onChangeKm:v=>u('oneWayKm',v),estimatedTravelH:travelH}),
      // ===== æŒ¯ã‚Šè¿”ã‚Š =====
      h('div',{style:{borderRadius:16,padding:16,display:'flex',flexDirection:'column',gap:20,background:'linear-gradient(180deg,rgba(59,130,246,0.05) 0%,rgba(15,23,42,0.6) 100%)',border:'1px solid rgba(59,130,246,0.1)'}},
        h('div',{style:{fontSize:13,fontWeight:700,color:'#cbd5e1',display:'flex',alignItems:'center',gap:8}},h('span',{style:{color:'#60a5fa'}},I.Star(14)),' æŒ¯ã‚Šè¿”ã‚Š',h('span',{style:{fontSize:10,fontWeight:400,color:'#475569',marginLeft:'auto'}},'â€»ä»»æ„ã§ã™ãŒè³‡ç”£ã«ãªã‚Šã¾ã™')),
        h('div',null,h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.Heart(11),' ã“ã®æ¡ˆä»¶ã®è² è·ã¯ï¼Ÿ'),EmojiSelector({items:BURDEN_LEVELS,value:form.burden,onChange:v=>u('burden',v),columns:5})),
        h('div',null,h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.Users(11),' ãŠå®¢æ§˜ã®åå¿œã¯ï¼Ÿ'),EmojiSelector({items:SATISFACTION_LEVELS,value:form.satisfaction,onChange:v=>u('satisfaction',v),columns:4})),
        h('div',null,h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.CreditCard(11),' æ”¯æ‰•ã„çŠ¶æ³'),GridSelector({items:PAYMENT_STATUS,value:form.paymentStatus,onChange:v=>u('paymentStatus',v),columns:5})),
        h('div',null,h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.RefreshCw(11),' ãƒªãƒ”ãƒ¼ãƒˆè¦‹è¾¼ã¿'),GridSelector({items:REPEAT_POTENTIAL,value:form.repeatPotential,onChange:v=>u('repeatPotential',v),columns:4})),
        // æœˆé¡ã‚µãƒãƒ¼ãƒˆæ¡ˆå†…
        h('div',null,
          h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.Award(11),' æœˆé¡ã‚µãƒãƒ¼ãƒˆã®æ¡ˆå†…'),
          EmojiSelector({items:MONTHLY_PITCH,value:form.monthlyPitch,onChange:v=>{u('monthlyPitch',v);if(v!=='pitched')u('joinProbability',null)},columns:3})
        ),
        showJoinProb&&h('div',{style:{animation:'slideDown .25s ease-out'}},
          h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.Target(11),' ä»Šå¾Œã®åŠ å…¥ç¢ºç‡ã¯ï¼Ÿ'),
          GridSelector({items:JOIN_PROBABILITY,value:form.joinProbability,onChange:v=>u('joinProbability',v),columns:6})
        )
      ),
      h('div',null,h('label',{style:{fontSize:12,color:'#64748b',marginBottom:6,display:'block'}},'ãƒ¡ãƒ¢'),h('textarea',{value:form.memo,onChange:e=>u('memo',e.target.value),rows:2,placeholder:'æ¬¡å›ã¸ã®æ°—ä»˜ãã€ãŠå®¢æ§˜ã®çŠ¶æ³ãªã©...',style:{width:'100%',padding:'14px 16px',borderRadius:16,fontSize:16,color:'#fff',background:'#1e293b',border:'none',outline:'none',resize:'none',fontFamily:'inherit'}})),
      h('button',{onClick:handleSave,disabled:!canSave||isSaving,style:{width:'100%',borderRadius:16,fontWeight:700,fontSize:16,border:'none',cursor:canSave&&!isSaving?'pointer':'not-allowed',display:'flex',alignItems:'center',justifyContent:'center',gap:10,padding:'18px',background:canSave&&!isSaving?'#2563eb':'#1e293b',color:canSave&&!isSaving?'#fff':'#64748b',boxShadow:canSave?'0 4px 16px rgba(37,99,235,.3)':'none',transition:'all .15s'}},
        isSaving?h('div',{style:{width:20,height:20,border:'2px solid rgba(255,255,255,.3)',borderTopColor:'#fff',borderRadius:'50%',animation:'spin 1s linear infinite'}}):h(Fragment,null,I.Send(18),' è¨˜éŒ²ã™ã‚‹')
      )
    )
  );
}

// ============================================================
// DASHBOARD
// ============================================================
function DashboardScreen({summary,goal,recentCases}){
  return h('div',{style:{padding:16,display:'flex',flexDirection:'column',gap:16,paddingBottom:32}},
    MonthPulse({summary,goal}),
    summary.cases>0?h(Fragment,null,
      h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}},
        [{l:'å£²ä¸Š',v:fmt(summary.revenue),s:summary.cases+'ä»¶'},{l:'å¹³å‡ROH',v:fmt(summary.avgROH),c:summary.avgROH>=CFG.rohThreshold?'#10b981':'#ef4444'},{l:'NGä»¶æ•°',v:summary.ngCount+'ä»¶',c:summary.ngCount>0?'#ef4444':'#10b981'}].map((k,i)=>h('div',{key:i,style:{borderRadius:16,padding:14,textAlign:'center',background:'#1e293b'}},h('div',{style:{fontSize:11,color:'#64748b'}},k.l),h('div',{className:'mono',style:{fontSize:16,fontWeight:700,marginTop:4,color:k.c||'#e2e8f0'}},k.v),k.s&&h('div',{style:{fontSize:11,color:'#475569',marginTop:2}},k.s)))
      ),
      h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}},
        h('div',{style:{borderRadius:16,padding:14,background:'#1e293b'}},h('div',{style:{fontSize:11,color:'#64748b',marginBottom:4}},'å¹³å‡è² è·'),h('div',{style:{display:'flex',alignItems:'center',gap:8}},h('span',{style:{fontSize:20}},(BURDEN_LEVELS.find(b=>b.id===Math.round(summary.avgBurden))||{emoji:'ğŸ˜'}).emoji),h('span',{className:'mono',style:{fontSize:15,fontWeight:700,color:'#e2e8f0'}},summary.avgBurden>0?summary.avgBurden.toFixed(1):'-'),h('span',{style:{fontSize:11,color:'#64748b'}},'/ 5'))),
        h('div',{style:{borderRadius:16,padding:14,background:summary.unpaidCount>0?'rgba(239,68,68,0.08)':'#1e293b',border:summary.unpaidCount>0?'1px solid rgba(239,68,68,0.2)':'none'}},h('div',{style:{fontSize:11,color:'#64748b',marginBottom:4}},'æœªå›å'),h('div',{style:{display:'flex',alignItems:'center',gap:8}},h('span',{className:'mono',style:{fontSize:15,fontWeight:700,color:summary.unpaidCount>0?'#ef4444':'#10b981'}},summary.unpaidCount>0?summary.unpaidCount+'ä»¶':'ãªã—'),summary.unpaidAmount>0&&h('span',{className:'mono',style:{fontSize:12,color:'#ef4444'}},fmt(summary.unpaidAmount))))
      ),
      recentCases.length>0&&h('div',null,h('div',{style:{fontSize:12,fontWeight:600,color:'#94a3b8',marginBottom:10,display:'flex',alignItems:'center',gap:6}},I.FileText(13),' ç›´è¿‘ã®è¨˜éŒ²'),h('div',{style:{borderRadius:16,padding:'0 16px',background:'#1e293b'}},recentCases.map((c,i)=>HistoryCard({key:i,c}))))
    ):h('div',{style:{padding:'48px 16px',textAlign:'center'}},h('div',{style:{fontSize:15,color:'#64748b',marginBottom:8}},'ã¾ã æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“'),h('div',{style:{fontSize:12,color:'#475569'}},'ã€Œè¨˜éŒ²ã€ã‚¿ãƒ–ã‹ã‚‰æœ€åˆã®æ¡ˆä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'))
  );
}

// ============================================================
// HISTORY
// ============================================================
function HistoryScreen({cases}){
  const[filter,setFilter]=useState('all');
  const filtered=cases.filter(c=>{if(filter==='ng')return c.rohStatus&&c.rohStatus.includes('NG');if(filter==='member')return c.customerType==='æœˆé¡ã‚µãƒãƒ¼ãƒˆä¼šå“¡';if(filter==='heavy')return c.burden&&c.burden>=4;return true});
  const fb=(key,label)=>h('button',{onClick:()=>setFilter(key),style:{padding:'10px 16px',borderRadius:12,fontSize:13,fontWeight:600,border:'none',cursor:'pointer',minHeight:44,background:filter===key?'#2563eb':'#1e293b',color:filter===key?'#fff':'#94a3b8',transition:'all .15s'}},label);
  return h('div',{style:{padding:16,display:'flex',flexDirection:'column',gap:16,paddingBottom:32}},
    h('div',{style:{display:'flex',gap:8,flexWrap:'wrap'}},fb('all','ã™ã¹ã¦'),fb('ng','NGæ¡ˆä»¶'),fb('heavy','é«˜è² è·'),fb('member','ä¼šå“¡')),
    h('div',{style:{borderRadius:16,padding:'0 16px',background:'#1e293b'}},
      filtered.length>0?filtered.map((c,i)=>HistoryCard({key:i,c})):h('div',{style:{padding:'48px 0',textAlign:'center',fontSize:15,color:'#64748b'}},cases.length===0?'ã¾ã æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“':'è©²å½“ã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“')
    )
  );
}

// ============================================================
// GOAL SETTINGS
// ============================================================
function GoalScreen({goal,onSaveGoal}){
  const now=new Date();
  const ym=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
  const[targetProfit,setTargetProfit]=useState(goal.targetProfit?String(goal.targetProfit):'');
  const[saving,setSaving]=useState(false);
  const[done,setDone]=useState(false);
  const tp=Number(targetProfit)||0;
  const estRevenue=tp>0?Math.round(tp/0.8):0;
  const estCases=estRevenue>0?Math.ceil(estRevenue/15000):0;
  const monthlyTarget=Math.round(CFG.annualTarget/12);

  function handleSave(){
    if(tp<=0)return;
    setSaving(true);
    const g={yearMonth:ym,targetProfit:tp,requiredRevenue:estRevenue,requiredCases:estCases};
    if(API_URL){apiPost('setGoal',g).then(()=>{onSaveGoal(g);setSaving(false);setDone(true);setTimeout(()=>setDone(false),2000)}).catch(()=>{onSaveGoal(g);setSaving(false);setDone(true);setTimeout(()=>setDone(false),2000)})}
    else{setTimeout(()=>{onSaveGoal(g);setSaving(false);setDone(true);setTimeout(()=>setDone(false),2000)},400)}
  }

  return h('div',{style:{padding:16,display:'flex',flexDirection:'column',gap:20,paddingBottom:32}},
    h('div',{style:{fontSize:16,fontWeight:700,color:'#e2e8f0',display:'flex',alignItems:'center',gap:8}},I.Settings(18),' æœˆæ¬¡ç›®æ¨™è¨­å®š'),
    h('div',{style:{borderRadius:16,padding:16,background:'#1e293b'}},h('div',{style:{fontSize:12,color:'#64748b',marginBottom:4}},'å¯¾è±¡æœˆ'),h('div',{style:{fontSize:20,fontWeight:700,color:'#e2e8f0'}},now.getFullYear()+'å¹´'+(now.getMonth()+1)+'æœˆ')),
    h('div',{style:{borderRadius:16,padding:16,background:'rgba(59,130,246,0.06)',border:'1px solid rgba(59,130,246,0.1)'}},
      h('div',{style:{fontSize:12,color:'#60a5fa',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.Info(12),' å¹´é–“ç›®æ¨™ã‹ã‚‰ã®å‚è€ƒå€¤'),
      h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}},
        h('div',null,h('div',{style:{fontSize:11,color:'#64748b'}},'å¹´é–“ç›®æ¨™ç²—åˆ©'),h('div',{className:'mono',style:{fontSize:15,fontWeight:700,color:'#e2e8f0'}},fmt(CFG.annualTarget))),
        h('div',null,h('div',{style:{fontSize:11,color:'#64748b'}},'æœˆå¹³å‡å¿…è¦é¡'),h('div',{className:'mono',style:{fontSize:15,fontWeight:700,color:'#60a5fa'}},fmt(monthlyTarget)))
      )
    ),
    NumInput({label:'ä»Šæœˆã®ç›®æ¨™ç²—åˆ©',iconFn:s=>I.Target(s),value:targetProfit,onChange:setTargetProfit,unit:'å††'}),
    tp>0&&h('div',{style:{borderRadius:16,padding:16,background:'#1e293b',animation:'slideDown .25s ease-out'}},
      h('div',{style:{fontSize:12,color:'#64748b',marginBottom:12}},'æ¦‚ç®—ï¼ˆå¹³å‡ç²—åˆ©ç‡80%ãƒ»å¹³å‡å˜ä¾¡\u00a515,000ã§ç®—å‡ºï¼‰'),
      h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}},
        h('div',null,h('div',{style:{fontSize:11,color:'#64748b'}},'å¿…è¦å£²ä¸Š'),h('div',{className:'mono',style:{fontSize:18,fontWeight:700,color:'#e2e8f0'}},fmt(estRevenue))),
        h('div',null,h('div',{style:{fontSize:11,color:'#64748b'}},'å¿…è¦æ¡ˆä»¶æ•°'),h('div',{className:'mono',style:{fontSize:18,fontWeight:700,color:'#e2e8f0'}},estCases+'ä»¶'))
      )
    ),
    h('button',{onClick:handleSave,disabled:tp<=0||saving,style:{width:'100%',borderRadius:16,fontWeight:700,fontSize:16,border:'none',cursor:tp>0&&!saving?'pointer':'not-allowed',display:'flex',alignItems:'center',justifyContent:'center',gap:10,padding:'18px',background:tp>0&&!saving?'#2563eb':'#1e293b',color:tp>0&&!saving?'#fff':'#64748b',transition:'all .15s'}},
      saving?h('div',{style:{width:20,height:20,border:'2px solid rgba(255,255,255,.3)',borderTopColor:'#fff',borderRadius:'50%',animation:'spin 1s linear infinite'}}):
      done?h(Fragment,null,I.CheckCircle(18),' ä¿å­˜ã—ã¾ã—ãŸ'):h(Fragment,null,I.Send(18),' ç›®æ¨™ã‚’è¨­å®š')
    ),
    !API_URL&&h('div',{style:{fontSize:11,color:'#f59e0b',textAlign:'center'}},'â€» GASæœªæ¥ç¶šã®ãŸã‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã¯æœªä¿å­˜'),
    // Googleãƒ•ã‚©ãƒ¼ãƒ ã«ã¤ã„ã¦
    h('div',{style:{borderRadius:16,padding:16,background:'rgba(15,23,42,0.6)',marginTop:8}},
      h('div',{style:{fontSize:12,color:'#64748b',marginBottom:8,display:'flex',alignItems:'center',gap:6}},I.Info(12),' Googleãƒ•ã‚©ãƒ¼ãƒ ã«ã¤ã„ã¦'),
      h('div',{style:{fontSize:11,color:'#475569',lineHeight:1.8}},'ä»¥å‰ã®è¨­è¨ˆã§ä½¿ç”¨ã—ã¦ã„ãŸGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ¡ˆä»¶å…¥åŠ›ãƒ»æœˆæ¬¡ç›®æ¨™ï¼‰ã¯ã€ã“ã®ç¾å ´ãƒãƒ¼ãƒˆPWAãŒå®Œå…¨ã«ç½®ãæ›ãˆã¾ã™ã€‚æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒ ã¯å‰Šé™¤ä¸è¦ã§ã™ãŒã€ä»Šå¾Œã¯ã“ã®ã‚¢ãƒ—ãƒªã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚')
    )
  );
}

// ============================================================
// APP
// ============================================================
function App(){
  const[tab,setTab]=useState('entry');
  const[cases,setCases]=useState([]);
  const[customers,setCustomers]=useState([]);
  const[summary,setSummary]=useState({revenue:0,profit:0,cases:0,memberCases:0,generalCases:0,avgROH:0,ngCount:0,avgBurden:0,unpaidCount:0,unpaidAmount:0});
  const[goal,setGoal]=useState({targetProfit:0,requiredRevenue:0,requiredCases:0});

  useEffect(()=>{
    if(!API_URL)return;
    apiGet('init').then(d=>{
      if(d&&d.ok){
        if(d.customers)setCustomers(d.customers);
        if(d.summary)setSummary(d.summary);
        if(d.recentCases)setCases(d.recentCases);
        if(d.goal&&d.goal.targetProfit)setGoal(d.goal);
      }
    }).catch(()=>{});
  },[]);

  function handleSave(data){
    const nc={id:'C'+Date.now(),date:data.date,customerName:data.customerName,customerType:data.customerType,catLarge:data.catLarge,revenue:Number(data.revenue),grossProfit:data.grossProfit,roh:data.roh,rohStatus:data.roh>=CFG.rohThreshold?'\u2705OK':'\u26a0\ufe0fNG',totalHours:data.totalHours,burden:data.burden,satisfaction:data.satisfaction};
    setCases(p=>[nc,...p]);
    setSummary(p=>{
      const n=p.cases+1,np=p.profit+nc.grossProfit;
      return{...p,revenue:p.revenue+nc.revenue,profit:np,cases:n,
        memberCases:nc.customerType==='æœˆé¡ã‚µãƒãƒ¼ãƒˆä¼šå“¡'?p.memberCases+1:p.memberCases,
        generalCases:nc.customerType!=='æœˆé¡ã‚µãƒãƒ¼ãƒˆä¼šå“¡'?p.generalCases+1:p.generalCases,
        avgROH:n>0?Math.round((p.avgROH*(n-1)+nc.roh)/n):nc.roh,
        ngCount:p.ngCount+(nc.roh<CFG.rohThreshold?1:0),
        avgBurden:nc.burden?Math.round(((p.avgBurden*(n-1)+nc.burden)/n)*10)/10:p.avgBurden,
        unpaidCount:data.paymentStatus==='pending'?p.unpaidCount+1:p.unpaidCount,
        unpaidAmount:data.paymentStatus==='pending'?p.unpaidAmount+nc.revenue:p.unpaidAmount};
    });
    setCustomers(prev=>{
      const idx=prev.findIndex(c=>c.name===data.customerName);
      if(idx>=0){const up=[...prev];const old=up[idx];const nc2=old.caseCount+1;up[idx]={...old,caseCount:nc2,lastKm:Number(data.oneWayKm)||old.lastKm,avgROH:Math.round((old.avgROH*old.caseCount+data.roh)/nc2),avgBurden:data.burden?Math.round(((old.avgBurden||3)*old.caseCount+data.burden)/nc2*10)/10:(old.avgBurden||3)};return up}
      return[...prev,{name:data.customerName,type:data.customerType,lastDate:data.date,caseCount:1,avgROH:data.roh,lastKm:Number(data.oneWayKm)||0,avgBurden:data.burden||3}];
    });
  }

  const tabs=[{key:'entry',icon:I.Plus,label:'è¨˜éŒ²'},{key:'dashboard',icon:I.Activity,label:'ä»Šæœˆ'},{key:'history',icon:I.FileText,label:'å±¥æ­´'},{key:'goal',icon:I.Settings,label:'è¨­å®š'}];

  return h('div',{style:{minHeight:'100vh',color:'#e2e8f0',background:'#0f172a'}},
    h('header',{style:{padding:'max(12px,env(safe-area-inset-top)) 16px 8px',background:'#0f172a',display:'flex',alignItems:'center',justifyContent:'space-between'}},
      h('div',null,h('h1',{style:{fontSize:16,fontWeight:700,color:'#e2e8f0',letterSpacing:1}},'ç¾å ´ãƒãƒ¼ãƒˆ'),h('p',{style:{fontSize:11,color:'#475569'}},'ITãƒ©ã‚¤ãƒ•ãƒ¯ãƒ¼ã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³')),
      h('div',{className:'mono',style:{fontSize:12,color:'#64748b'}},new Date().toLocaleDateString('ja-JP',{month:'long',day:'numeric',weekday:'short'}))
    ),
    ApiBanner(),
    h('main',{style:{paddingBottom:'calc(4.5rem + env(safe-area-inset-bottom))'}},
      tab==='entry'&&CaseEntry({onSave:handleSave,customers}),
      tab==='dashboard'&&DashboardScreen({summary,goal,recentCases:cases.slice(0,5)}),
      tab==='history'&&HistoryScreen({cases}),
      tab==='goal'&&GoalScreen({goal,onSaveGoal:setGoal})
    ),
    h('nav',{style:{position:'fixed',bottom:0,left:0,right:0,borderTop:'1px solid rgba(30,41,59,.5)',display:'flex',background:'rgba(15,23,42,0.97)',backdropFilter:'blur(20px)',paddingBottom:'env(safe-area-inset-bottom)'}},
      tabs.map(t=>h('button',{key:t.key,onClick:()=>setTab(t.key),style:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:2,minHeight:52,paddingTop:8,paddingBottom:4,border:'none',cursor:'pointer',background:'transparent',color:tab===t.key?'#60a5fa':'#475569',transition:'color .15s'}},t.icon(22),h('span',{style:{fontSize:10,fontWeight:600}},t.label)))
    )
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(h(App));
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}
</script>
</body>
</html>
